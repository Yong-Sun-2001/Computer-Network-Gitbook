# 第四章（下）——网络层

## 重点

1. ICMP协议：询问报文、差错报文
2. 路由算法：静态/动态路由算法
3. 路由选择协议：内部/外部网关协议
4. IP多播：多播IP地址、硬件多播

## 内容

1. ICMP:Internet Control MessageProtocol 网际控制报文协议

2. ICMP报文格式

   <img src="images\image-20211114145021516.png" alt="image-20211114145021516" style="zoom:67%;" />

3. ICMP报文种类：ICMP差错报告报文和 ICMP 询问报文

4. ICMP差错报告报文：向源站点报告错误信息，不需要应答。可分为以下类型：

   1. 终点不可达：网络不可达、主机不可达、协议不可达、端口 不可达、需分片但DF为1、源路由失败等6种
   2. 时间超过：路由器收到TTL为0的数据报时，丢弃且报告
   3. 参数问题：收到的数据报首部有字段不正确时
   4. 改变路由：路由器发给主机让其知道下次应将数据报发送给 另外的路由器
   
5. ICMP差错报告报文的数据部分：包含ICMP差错报告报文的前8个字节，再加上**引起错误的IP数据报的首部和数据字段的前8个字节**。

  <img src="images\image-20211114145448125.png" alt="image-20211114145448125" style="zoom: 67%;" />
  
6. 不应发送 ICMP 差错报告报文的几种情况：

   1. 对 ICMP 差错报告报文不再发送 ICMP 差错报 告报文
   2. 对第一个分片的数据报片的所有后续数据报片 都不发送 ICMP 差错报告报文
   3. 对具有多播地址的数据报都不发送 ICMP 差错 报告报文
   4. 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的 数据报不发送 ICMP 差错报告报文

7. ICMP询问报文：采用请求/应答方式进行交互，用来 请求一些消息。可分为以下类型：

   1. **回送请求和回答报文** ：由主机或者路由器向一个特定的目的主机发出询问，收到 此报文的机器给源主机应答。一般用来测试目的机器是否 可达。如：PING、Traceroute【用来跟踪一个分组从源点到终点的路径】
   2. **时间戳请求和回答报文** ：请求某个主机或路由器回答当前的日期和时间。用于时钟同步或测量时间。

8. 路由算法

   1. **静态路由选择策略**：即**非自适应路由选择**，其 特点是简单和开销较小，但不能及时适应网络 状态的变化。
   2. **动态路由选择策略**：即**自适应路由选择**，其特 点是能较好地适应网络状态的变化，但实现起 来较为复杂，开销也比较大。

9. 分层次的路由选择协议：互联网的路由选择协议主要是自适应的（即动 态的）、分布式的路由选择协议。

10. 两大类路由选择协议

   1. 内部网关协议 IGP (Interior Gateway Protocol) ：在一个自治系统内部使用的路由选择协议。例如：RIP、OSPF
   2. 外部网关协议 EGP (External Gateway Protocol)：将路由选择信息传递到另一个自治系统中。例如：BGP-4

* 自治系统之间的路由选择也叫做**域间路由选择 (interdomain routing)**，在自治系统内部的路由选 择叫做**域内路由选择 (intradomain routing)** 

11. RIP：Routing Information Protocol 路由信息协议
    1. RIP 是一种分布式的、基于距离向量的动态路由选择协议
    2. 每一个路由器都要维护从它自己到其他每一个目的网络的唯一最佳距离记录，固定的时间间隔与相邻的路由器交换路由信息
    3. RIP 允许一条路径最多只能包含 15 个路由器，距离为16时表示不可达
    4. 使用距离向量算法【基础是 Bellman-Ford 算法】
    5. RIP协议报文存于UDP数据报的数据部分
    6. 优点：实现简单，开销较小
    7. 缺点：
       1. RIP 限制了网络的规模，它能使用的最大距离为 15 （16 表示不可达）
       2. 路由器之间交换的路由信息是路由器中的完整路由 表，因而随着网络规模的扩大，开销也就增加。
       3. 当网络出现故障时，要经过比较长的时间才能将此 信息传送到所有的路由器【**好消息传播得快，坏消息传播得慢**】（慢收敛问题）
    
12. OSPF：Open Shortest Path First ，开放最短路径优先

    1. 采用分布式的链路状态协议 (link state  protocol)

    2. 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法。

    3. 发送的信息就是**与本路由器相邻的所有路由器的链路状态**，但这只是路由器所知道的部分信息

    4. 只有当链路状态发生变化时，路由器才用洪泛法向所 有路由器发送此信息

       <img src="images\image-20211114154109616.png" alt="image-20211114154109616" style="zoom:67%;" />

    5. OSPF 不用 UDP 而是直接用 IP 数据报传送
    
    6. OSPF 分组使用24字节的固定长度首部
    
    7. 特点：
    
       1. 负载均衡 (load balancing)：到同一个网络有多 条相同代价的路径，可以将通信量分配给这几条 路径。
       2. 每一个链路状态都带上一个 32 位的序号，序号 越大状态就越新。解决重复分组问题。
       3. OSPF 没有“坏消息传播得慢”的问题
       4. 只涉及到与相邻路 由器的连通状态，因而与整个互联网的规模并无直接关系。适合大规模网络

13. BGP： (Border Gateway Protocol)(边界网关协议)

    1. 采用**路径向量路由选择协议**。
    2.  与其他AS的邻站BGP发言人交换信息。
    3. 交换的信息是网络可达性的信息，即到达某个网络所 要经过的一系列AS。
    4. 发生变化时更新有变化的部分。
    5. 存放于TCP报文数据部分
    
14. 路由器：转发分组、路由选择

    1. 路由表是根据路由选择算法得出的。而转发表是从路 由表得出的
    
15. IP多播：一对多通信

    <img src="images\image-20211114163313934.png" alt="image-20211114163313934" style="zoom:67%;" />

- 多播数据报和一般的 IP 数据报的区别就是它使 用 **D 类 IP 地址**作为目的地址，并且首部中的**协议字段值是 2**，表明使用**网际组管理协议 IGMP**。

- 以太网硬件地址字段中的第1字节的最低位(I/G位)为1时为多播 地址。

  <img src="images\image-20211114163716209.png" alt="image-20211114163716209" style="zoom:67%;" />

  <img src="\images\image-20211114163733107.png" alt="image-20211114163733107" style="zoom:67%;" />
16. IGMP：网际组管理协议 IGMP (Internet Group Management  Protocol)