# 第四章（上）——网络层

## 重点
1. 网络层功能：异构网络互连、尽最大努力交付
2. IPv4地址：分类地址、无分类地址
3. 地址解析ARP协议
4. IP首部格式

## 内容

1. 网络层提供的服务

   1. 观点一：虚电路服务：通信之前先建立虚电路 (Virtual Circuit)，以保 证双方通信所需的一切网络资源。

   2. 观点二：数据报服务：网络层向上只提供简单灵活的、无连接的、尽最大 努力交付(不可靠)的数据报服务，对源主机没有任 何承诺。【实际使用】
      ![image-20211113164739111](images\image-20211113164739111.png)

2. 网际协议 IP
   - 地址解析协议 ARP (Address Resolution Protocol）
   - 网际控制报文协议 ICMP (Internet Control Message Protocol）
   - 网际组管理协议 IGMP(Internet Group Management Protocol
   
3. 分类的IP地址

   ![image-20211113165408341](images\image-20211113165408341.png)

   ![image-20211113171844140](images\image-20211113171844140.png)

   ![image-20211113172049205](images\image-20211113172049205.png)

![image-20211113172236254](images\image-20211113172236254.png)

4. ARP协议
   - 从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。
   - ARP 是解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题
   - ARP 高速缓存中：各主机和路由器的 IP 地址到硬件地址的映射表
   - ARP请求分组：发送方 ARP 高速缓存中没有目的方的地址时，在本局域网上广播请求分组
   - ARP响应分组：需要包括发送/目标方的IP地址和硬件地址，单播

5. IP数据报的首部格式

   ![image-20211113175410225](images\image-20211113175410225.png)

   - 版本：IPv4
   - 首部长度：4位，最多表示15，以4个字节为单位，故首部最大长度为60字节
   - 总长度：占 16 位，指首部和数据之和的长度， 单位为字节，因此数据报的最大长度为 65535 字节。 总长度必须不超过最大传送单元 MTU。
   - 标识：计数器，用于产生IP数据报的标识
   - 标志：占3位，目前前两位有效，分别为MF（More Fragment）和DF(Dont Fragment) ,MF=1表示后面还有分片，DF=0表示可以分片
   - 片偏移：占13 位，指出：较长的分组在分片后某片在原分组中的相对位置。 片偏移以 8 个字节为偏移单位。
   - 生存时间：占8 位，记为 TTL (Time To Live)， 指示数据报在网络中可通过的路由器数的最大值
   - 协议：占8 位，指出此数据报携带的数据使用何种协议， 以便目的主机的 IP 层将数据部分 上交给那个处理过程
   - 首部检验和：占16 位，只检验数据报的首部， 不检验数据部分。这里不采用 CRC 检验码而采用 简单的计算方法。

![image-20211113180026177](images\image-20211113180026177.png)

![image-20211113180941226](images\image-20211113180941226.png)

6. 路由器分组转发算法

   ![image-20211113181342475](images\image-20211113181342475.png)
   
7. 划分子网
   - 划分子网：从两级 IP 地址到三级 IP 地址，减少了 IP 地址的浪费，使网络的组织更加灵活，更便于维护和管理
   - 划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。【子网号不能为全0/1】
   - ![image-20211113182041966](images\image-20211113182041966.png)

8. CIDR【斜线记法】
   - 无分类域间路由选择CIDR (Classless Inter-Domain Routing)
   - 使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网
   - IP 地址从三级编址（使用子网掩码）又回到了两级编址
   - 全 0 和全 1 的主机号地址一般不使用，但是说CIDR的某一地址块的最小最大地址时为全0/1地址
   - 路由聚合【构成超网】：最长前缀匹配、使用二叉线索查找路由表

