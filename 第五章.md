# 第五章——传输层

## 重点

1. UDP协议特点
2. UDP协议首部格式
3. TCP协议特点
4. TCP可靠传输工作原理
5. TCP首部格式
6. TCP连接管理：3次/4次握手
7. TCP可靠传输
8. TCP流量控制
9. TCP拥塞控制



## 内容

1. 运输层：运输层的复用和分用功能依赖**端口**来完成的
   1. 复用：发送方不同的应用进程使用同一个运输层协议
   2. 分用：接收方的运输层把数据正确交付给目的进程
   
2. 术语：
   1. 运输协议数据单元 TPDU (Transport Protocol Data Unit)
   2. TCP：传输控制协议 TCP (Transmission Control  Protocol)
   3. UDP： 用户数据报协议 UDP (User Datagram Protocol)
   
3. TCP可靠信道：管道中运输：无差错、按序（接收和发送的顺序）、 无丢失、无重复

4. UDP不可靠信道：不保证交付。接收时不按序、可能出现丢失 和重复。
 <img src="\images\image-20211114174142840.png" alt="image-20211114174142840" style="zoom:67%;" />

5. 端口：16位

   1. 熟知端口：0-1023

   2. 登记端口

   3. 短暂端口

      <img src="\images\image-20211114174401403.png" alt="image-20211114174401403" style="zoom:67%;" />

6. UDP： 用户数据报协议 UDP (User Datagram Protocol)

   1. 一种无连接协议
   2. 在传送数据之前不需要先建立连接。
   3. 传送的数据单位协议是 UDP 报文 或 用户数据报。
   4. 对方的运输层在收到 UDP 报文后，不需要给出任何 确认。 
   5. 不提供可靠交付
   6. 没有拥塞控制，网络出现的拥塞不会使源主机的 发送速率降低
   7. 支持一对一、一对多、多对一和多对多的交互通信
   8. UDP 对应用层交下来的报文，既不 合并，也不拆分，而是保留这些报文的边界。
   9. 一次发送一个报文，一次交付一个完整的报文
   10. <img src="\images\image-20211114174708000.png" alt="image-20211114174708000" style="zoom:67%;" />
   11. <img src="images\image-20211114174836766.png" alt="image-20211114174836766" style="zoom:67%;" />
   12. 端口是用报文队列来实现

7. TCP:

   1. 可靠的、面向连接的运输服务
   2. 传送的数据单位协议是 TCP 报文段 (segment)。
   3. TCP 不提供广播或多播服务，一对一
   4. 全双工
   5. 面向字节流：虽然应用程序和 TCP 的交互是一 次一个数据块（大小不等），但 TCP 把应用程序交下来的数 据看成仅仅是一连串无结构的字节流
   6. 套接字 socket = (IP地址 : 端口号)
   7. 同一个 IP 地址可以有多个不同的 TCP 连接
   8. 同一个端口号也可以出现在多个不同的 TCP 连接中

8. TCP可靠传输

   1. 停止等待协议：每发送完一个分组就停止发 送，等待对方的确认。
      1. 确认丢失：A 在超时计时器到期后就要重传 M1，B收到后也要重传确认
      2. 确认迟到：A对迟到的确认丢弃，B对重传的M1也要重传确认
      3. 缺点是信道利用率太低
      
   2. 自动重传请求ARQ
      1. 发送方维持发送窗口，位于发送窗口内的分组都可连续发送出去，而不需要 等待对方的确认。
      2. 发送方每收到一个确认， 就把发送窗口向前滑动一个分组的位置
      3. 接收方一般采用**累积确认**的方式
      4. Go-back-N（回退 N）：超时未收到确认，中间分组丢失，后面的都要重传
      5. 发送窗口最大值：$$2^n-1$$ 【n比特的分组编号】
      6. 接收窗口为1
      
   3. 选择重传ARQ协议
      1. 只重传出错帧或计时器超时的数据帧
      2. 该策略对应接收窗口大于1的情况，即暂存接收窗口中序号 在出错帧之后的数据帧
      3. 发送窗口最大值：$$2^{n-1}$$
      4. 发送窗口的尺寸一般和接收窗口的尺寸相同
      
   4. TCP 的可靠传输机制用字节的序号进行控制。TCP 所有的确认都是**基于序号**而不是基于报文段。需要使用特定的算法**估算较为合理的重传时间**

      <img src="images\image-20211116114409678.png" alt="image-20211116114409678" style="zoom:67%;" />

      <img src="images\image-20211116114546529.png" alt="image-20211116114546529" style="zoom:67%;" />

9. TCP报文段首部：固定前20字节，后面可选

   <img src="images\image-20211116113110752.png" alt="image-20211116113110752" style="zoom:67%;" />

  - 数据偏移（即首部长度）——占 4 位，它指出 TCP 报文段的数据 起始处距离 TCP 报文段的起始处有多远。“数据偏移”的单位是 32 位字（以 4 字节为计算单位）。
  - MSS (Maximum Segment Size) 是 TCP 报文段中的数据字段的最大长度，缺省为 536字节
10. TCP连接建立过程：TCP连接的建立采用客户服务器方式

    1. 连接建立 ：建立连接的过程叫做握手，采用三报文握手

       <img src="images\image-20211116113906818.png" alt="image-20211116113906818" style="zoom:67%;" />

    2. 数据传送 

    3. 连接释放：四报文握手。必须经过2MSL释放的原因：第一，为了保证 A 发送的最后一个 ACK 报文 段能够到达 B。 第二，防止 “已失效的连接请求报文段”出现 在本连接中。

       <img src="images\image-20211116114007962.png" alt="image-20211116114007962" style="zoom:67%;" />
    
11. TCP流量控制

    1. 利用**滑动窗口**实现流量控制
    2. TCP 为每一个连接设有一个**持续计时器**防止死锁【死锁：接收方的非零窗口通知丢失】

12. TCP拥塞控制

    1. 原因：对资源需求 > 可用资源

    2. 感知拥塞：重传定时器超时、发送端收到3个重复的ACK

    3. 限制发送速率的机制：维持一个拥塞窗口 CWND【真正的发送窗口值 = Min(公告窗口值，拥塞窗口值)】

    4. 拥塞窗口的调节策略

       1. AIMD：乘法减小、加法增大：检测到拥塞时cwnd=cwnd/2；若无丢包则加法增大，每过一个个RTT，cwnd+1。

       2. 慢开始：每经过一个RTT，将cwnd加倍，到达门限后使用**拥塞避免算法**

          <img src="images\image-20211116115618980.png" alt="image-20211116115618980" style="zoom:67%;" />

       3. 收到3个重复ACK：执行快重传/恢复算法。门限=cwnd/2，cwnd=门限，开始拥塞避免（AIMD）【线性增长】
       
       4. 超时：门限=cwnd/2，cwnd=1,使用慢启动再是AIMD【指数增长再是线性增长】

